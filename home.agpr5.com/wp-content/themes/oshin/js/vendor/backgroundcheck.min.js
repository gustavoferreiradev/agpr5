!function(t,e){"function"==typeof define&&define.amd?define(e):t.BackgroundCheck=e()}(this,function(){"use strict";function t(){W=null,H=null,T=null,S={},M&&clearTimeout(M)}function e(t){x("debug")&&console.log(t)}function i(t,e){return n(t,typeof e),void 0===t?e:t}function n(t,e){if(void 0!==t&&typeof t!==e)throw"Incorrect attribute type"}function o(t){for(var i,n,o=[],a=0;a<t.length;a++)if(i=t[a],o.push(i),"IMG"!==i.tagName){if((n=window.getComputedStyle(i).backgroundImage).split(/,url|, url/).length>1)throw"Multiple backgrounds are not supported";if(!n||"none"===n)throw"Element is not an <img> but does not have a background-image";o[a]={img:new Image,el:o[a]},n=(n=n.slice(4,-1)).replace(/"/g,""),o[a].img.src=n,e("CSS Image - "+n)}return o}function a(t,e){var i=t;if("string"==typeof t?i=document.querySelectorAll(t):t&&1===t.nodeType&&(i=[t]),!i||0===i.length||void 0===i.length)throw"Elements not found";return e&&(i=o(i)),i=Array.prototype.slice.call(i)}function r(){(H=document.createElement("canvas"))&&H.getContext?(T=H.getContext("2d"),W=!0):W=!1,g()}function g(){x("debugOverlay")?(H.style.opacity=.5,H.style.pointerEvents="none",document.body.appendChild(H)):H.parentNode&&H.parentNode.removeChild(H)}function l(i){var n=(new Date).getTime()-i;e("Duration: "+n+"ms"),n>x("maxDuration")&&(console.log("BackgroundCheck - Killed"),f(),t())}function d(){E={left:0,top:0,right:document.body.clientWidth,bottom:window.innerHeight},H.width=document.body.clientWidth,H.height=window.innerHeight}function h(t,e,i){var n,o;return-1!==t.indexOf("px")?n=parseFloat(t):-1!==t.indexOf("%")?(n=parseFloat(t),o=n/100,n=o*e,i&&(n-=i*o)):n=e,n}function u(t){var e=window.getComputedStyle(t.el);t.el.style.backgroundRepeat="no-repeat",t.el.style.backgroundOrigin="padding-box";var i=e.backgroundSize.split(" "),n=i[0],o=void 0===i[1]?"auto":i[1],a=t.el.clientWidth/t.el.clientHeight,r=t.img.naturalWidth/t.img.naturalHeight;"cover"===n?a>=r?(n="100%",o="auto"):(n="auto",i[0]="auto",o="100%"):"contain"===n&&(1/r>1/a?(n="auto",i[0]="auto",o="100%"):(n="100%",o="auto")),n="auto"===n?t.img.naturalWidth:h(n,t.el.clientWidth),o="auto"===o?n/t.img.naturalWidth*t.img.naturalHeight:h(o,t.el.clientHeight),"auto"===i[0]&&"auto"!==i[1]&&(n=o/t.img.naturalHeight*t.img.naturalWidth);var g=e.backgroundPosition;"top"===g?g="50% 0%":"left"===g?g="0% 50%":"right"===g?g="100% 50%":"bottom"===g?g="50% 100%":"center"===g&&(g="50% 50%");var l,d;return 4===(g=g.split(" ")).length?(l=g[1],d=g[3]):(l=g[0],d=g[1]),d=d||"50%",l=h(l,t.el.clientWidth,n),d=h(d,t.el.clientHeight,o),4===g.length&&("right"===g[0]&&(l=t.el.clientWidth-t.img.naturalWidth-l),"bottom"===g[2]&&(d=t.el.clientHeight-t.img.naturalHeight-d)),l+=t.el.getBoundingClientRect().left,d+=t.el.getBoundingClientRect().top,{left:Math.floor(l),right:Math.floor(l+n),top:Math.floor(d),bottom:Math.floor(d+o),width:Math.floor(n),height:Math.floor(o)}}function c(t){var e,i,n;if(t.nodeType){var o=t.getBoundingClientRect();e={left:o.left,right:o.right,top:o.top,bottom:o.bottom,width:o.width,height:o.height},n=t.parentNode,i=t}else e=u(t),n=t.el,i=t.img;n=n.getBoundingClientRect(),e.imageTop=0,e.imageLeft=0,e.imageWidth=i.naturalWidth,e.imageHeight=i.naturalHeight;var a,r=e.imageHeight/e.height;return e.top<n.top&&(a=n.top-e.top,e.imageTop=r*a,e.imageHeight-=r*a,e.top+=a,e.height-=a),e.left<n.left&&(a=n.left-e.left,e.imageLeft+=r*a,e.imageWidth-=r*a,e.width-=a,e.left+=a),e.bottom>n.bottom&&(a=e.bottom-n.bottom,e.imageHeight-=r*a,e.height-=a),e.right>n.right&&(a=e.right-n.right,e.imageWidth-=r*a,e.width-=a),e.imageTop=Math.floor(e.imageTop),e.imageLeft=Math.floor(e.imageLeft),e.imageHeight=Math.floor(e.imageHeight),e.imageWidth=Math.floor(e.imageWidth),e}function m(t){var i=c(t);t=t.nodeType?t:t.img,i.imageWidth>0&&i.imageHeight>0&&i.width>0&&i.height>0?T.drawImage(t,i.imageLeft,i.imageTop,i.imageWidth,i.imageHeight,i.left,i.top,i.width,i.height):e("Skipping image - "+t.src+" - area too small")}function s(t,e,i){var n=t.className;switch(i){case"add":n+=" "+e;break;case"remove":var o=new RegExp("(?:^|\\s)"+e+"(?!\\S)","g");n=n.replace(o,"")}t.className=n.trim()}function f(t){for(var e,i=t?[t]:x("targets"),n=0;n<i.length;n++)e=i[n],e=x("changeParent")?e.parentNode:e,s(e,x("classes").light,"remove"),s(e,x("classes").dark,"remove"),s(e,x("classes").complex,"remove")}function p(t){var i,n,o,a,r=t.getBoundingClientRect(),g=0,l=0,d=0,h=0,u=x("mask");if(r.width>0&&r.height>0){f(t),t=x("changeParent")?t.parentNode:t,n=T.getImageData(r.left,r.top,r.width,r.height).data;for(var c=0;c<n.length;c+=4)n[c]===u.r&&n[c+1]===u.g&&n[c+2]===u.b?h++:(g++,i=.2126*n[c]+.7152*n[c+1]+.0722*n[c+2],o=i-d,l+=o*o,d+=o/g);h<=n.length/4*(1-x("minOverlap")/100)&&(a=Math.sqrt(l/g)/255,d/=255,e("Target: "+t.className+" lum: "+d+" var: "+a),s(t,d<=x("threshold")/100?x("classes").dark:x("classes").light,"add"),a>x("minComplexity")/100&&s(t,x("classes").complex,"add"))}}function v(t,e){return t=(t.nodeType?t:t.el).getBoundingClientRect(),e=e===E?e:(e.nodeType?e:e.el).getBoundingClientRect(),!(t.right<e.left||t.left>e.right||t.top>e.bottom||t.bottom<e.top)}function w(t){for(var e,i=(new Date).getTime(),n=t&&("IMG"===t.tagName||t.img)?"image":"targets",o=!t,a=x("targets").length,r=0;a>r;r++)e=x("targets")[r],v(e,E)&&("targets"!==n||t&&t!==e?"image"===n&&v(e,t)&&p(e):(o=!0,p(e)));if("targets"===n&&!o)throw t+" is not a target";l(i)}function y(t){var e=function(t){var e=0;return"static"!==window.getComputedStyle(t).position&&(e=parseInt(window.getComputedStyle(t).zIndex,10)||0)>=0&&e++,e},i=t.parentNode;return 1e5*(i?e(i):0)+e(t)}function b(t){var i=!1;return t.sort(function(t,e){t=t.nodeType?t:t.el,e=e.nodeType?e:e.el;var n=t.compareDocumentPosition(e),o=0;return t=y(t),e=y(e),t>e&&(i=!0),t===e&&2===n?o=1:t===e&&4===n&&(o=-1),o||t-e}),e("Sorted: "+i),i&&e(t),i}function k(t,i,n){if(W){var o=x("mask");e("--- BackgroundCheck ---"),e("onLoad event: "+(n&&n.src)),!0!==i&&(T.clearRect(0,0,H.width,H.height),T.fillStyle="rgb("+o.r+", "+o.g+", "+o.b+")",T.fillRect(0,0,H.width,H.height));for(var a,r,g=n?[n]:x("images"),l=b(g),d=!1,h=0;h<g.length;h++)a=g[h],v(a,E)&&(0===(r=a.nodeType?a:a.img).naturalWidth?(d=!0,e("Loading... "+a.src),r.removeEventListener("load",k),l?r.addEventListener("load",k.bind(null,null,!1,null)):r.addEventListener("load",k.bind(null,t,!0,a))):(e("Drawing: "+a.src),m(a)));n||d?n&&w(n):w(t)}}function C(t){!0===x("windowEvents")&&(M&&clearTimeout(M),M=setTimeout(t,200))}function x(t){if(void 0===S[t])throw"Unknown property - "+t;return S[t]}var W,H,T,M,E,L=void 0!==window.orientation?"orientationchange":"resize",S={};return{init:function(t){if(void 0===t||void 0===t.targets)throw"Missing attributes";S.debug=i(t.debug,!1),S.debugOverlay=i(t.debugOverlay,!1),S.targets=a(t.targets),S.images=a(t.images||"img",!0),S.changeParent=i(t.changeParent,!1),S.threshold=i(t.threshold,50),S.minComplexity=i(t.minComplexity,30),S.minOverlap=i(t.minOverlap,50),S.windowEvents=i(t.windowEvents,!0),S.maxDuration=i(t.maxDuration,500),S.mask=i(t.mask,{r:0,g:255,b:0}),S.classes=i(t.classes,{dark:"background--dark",light:"background--light",complex:"background--complex"}),void 0===W&&(r(),W&&(H.style.position="fixed",H.style.top="0px",H.style.left="0px",H.style.width="100%",H.style.height="100%",window.addEventListener(L,C.bind(null,function(){d(),k()})),window.addEventListener("scroll",C.bind(null,k)),d(),k()))},destroy:t,refresh:k,set:function(t,e){if(void 0===S[t])throw"Unknown property - "+t;if(void 0===e)throw"Missing value for "+t;if("targets"===t||"images"===t)try{e=a("images"!==t||e?e:"img","images"===t)}catch(t){throw e=[],t}else n(e,typeof S[t]);f(),S[t]=e,k(),"debugOverlay"===t&&g()},get:x,getImageData:function(){for(var t,e=x("images"),i=[],n=0;n<e.length;n++)t=c(e[n]),i.push(t);return i}}});